#!/bin/sh

CACHE=/var/cache/sandbox-essential

set -e

[ -f $CACHE ] && exit 0

{
	dpkg-query -f='${Package} ${Essential}\n' -W \
		| grep ' yes$'
	dpkg-query -f='${Package} ${Priority}\n' -W \
		| egrep ' (important|required|standard)$'
} | cut -d' ' -f1 | sort | uniq >$CACHE

while true
do
	cp $CACHE $CACHE.new
	while read PACKAGE
	do
		dpkg-query -f='${Pre-Depends}\n${Depends}\n' -W $PACKAGE \
			| tr ',|' '\n' | tr -d ' ' \
			| cut -d'(' -f1
		dpkg-query -f='${Package} ${Provides}\n' -W \
			| grep " $PACKAGE\$" \
			| cut -d' ' -f1
	done <$CACHE >>$CACHE.new
	grep -v '^$' <$CACHE.new | sort | uniq >$CACHE.tmp
	[ "$(
		md5sum $CACHE | cut -d' ' -f1
	)" = "$(
		md5sum $CACHE.tmp | cut -d' ' -f1
	)" ] && {
		rm $CACHE.new $CACHE.tmp
		exit 0
	}
	mv $CACHE.tmp $CACHE
done
